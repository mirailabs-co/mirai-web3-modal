# mirai-scripts

## Installation

To install the package, use one of the following commands

```sh
npm install --save-dev @mirailabs-co/mirai-scripts
# OR
yarn add -D @mirailabs-co/mirai-scripts
```

You can check if you have the right version using

```sh
npx mirai-scripts --version
```

## Usage

You can create scripts inside package.json as follows

```json
{
	"scripts": {
		"start": "mirai-scripts start",
		"build": "mirai-scripts build"
	}
}
```

You can invoke these scripts using either npm or Yarn:

```sh
npm run build
# OR
yarn build
```

If you have npx available (should be bundled with an up-to-date version of npm), you can also invoke the binary directly with:

```sh
npx mirai-scripts build
```

### mirai.config.js

`mirai.config.js` is an optional config file that will be automatically loaded by `mirai-scripts` service if it's present in your project root (next to `package.json`).

The following options are supported

```ts
interface IOptions {
	name: string; // Name of bundles in dist folder. Default: name in package.json (but in camelCase)
	esm: boolean; // Whether to generate an esm build. Default: true
	cjs: boolean; // Whether to generate a cjs build. Default: true
	umd: boolean; // Whether to generate an umd build. Default: true
	cjsBundled: boolean; // Whether to generate an cjs build with troubling deps bundled. Default: false
	bundledDeps: string[]; // What deps to bundle while generating cjsBundled build. Default: false
	analyzerMode: 'disabled' | 'static' | 'server' | 'json'; // Whether to analyze the umd build. Internally uses webpack-bundle-analyzer. Default: "disabled". Refer to full options here: https://github.com/webpack-contrib/webpack-bundle-analyzer
	browserslistrc: string | string[]; // The browserlist to target. Default: ["> 0.25%", "not dead", "not ie 11"]. Full list: https://github.com/browserslist/browserslist
}
```

### Config precedence

<b> browserslist </b>
The order of preference for browserslist config is as follows:

1. `.browserslistrc` file at package root
2. `browserslistrc` key in `mirai.config.js`
3. `browserslist.production` key in `package.json`
4. `browserslist` key in `package.json`
5. [Default](./defaults/mirai.config.js)

<b> typescript </b>
The tsconfig is generated as follows:

1. `tsconfig.build.json` file at package root
2. [Default](./defaults/tsconfig.build.js)

Both 1 & 2 are merged using `lodash.mergewith` and the generated config is used.
So, it's okay to specify partial config in tsconfig.build.json

<b> babel </b>
The babel config is generated as follows:

1. `babel.config.js` file at package root
2. [Default](./defaults/babel.config.js)

Both 1 & 2 are merged using `babel-merge` and the generated config is used.
So, it's okay to specify partial config in babel.config.js

<b> rollup </b>
The rollup config is generated as follows:

1. `rollup.config.js` file at package root
2. [Default](./config/rollup.config.js)

Both 1 & 2 are merged using `lodash.mergewith` and the generated config is used.
So, it's okay to specify partial config in rollup.config.js
you can also specify newer build types in this case using outputs

eg:

To add other plugins

```js
import replace from '@rollup/plugin-replace';

// This adds `replace` plugin to the existing plugins used by mirai-scripts
export default {
	plugins: [
		replace({
			'process.env.INFURA_PROJECT_ID': `"${process.env.INFURA_PROJECT_ID}"`,
			preventAssignment: true,
		}),
	],
};
```

<b> webpack </b>
The webpack config is generated as follows:

1. `webpack.config.js` file at package root
2. [Default](./config/webpack.config.js)

Both 1 & 2 are merged using `lodash.mergewith` and the generated config is used.
So, it's okay to specify partial config in webpack.config.js
you can also specify newer build types in this case by adding a new key in the exports

eg:

To create a new build type

```js
const pkg = require('./package.json');

const pkgName = 'fetchNodeDetails';

// Adding this creates a new build type in the dist/ folder
exports.nodeConfig = {
	optimization: {
		minimize: false,
	},
	output: {
		filename: `${pkgName}-node.js`,
		libraryTarget: 'commonjs2',
	},
	externals: [...Object.keys(pkg.dependencies), /^(@babel\/runtime)/i],
	target: 'node',
};
```

To add plugins or other config to all build types

```js
const path = require('path');
const { EnvironmentPlugin } = require('webpack');

exports.baseConfig = {
	resolve: {
		alias: {
			'bn.js': path.resolve(__dirname, 'node_modules/bn.js'),
			lodash: path.resolve(__dirname, 'node_modules/lodash'),
			'js-sha3': path.resolve(__dirname, 'node_modules/js-sha3'),
		},
	},
	plugins: [new EnvironmentPlugin(['INFURA_PROJECT_ID'])],
};
```

### mirai-scripts build

```
Usage: mirai-scripts build [options]
Use e.g. "mirai-scripts build" directly".
Options:
  -h --help              Print this help
  -n --name              Name of the project

```

`mirai-scripts build` produces a production-ready bundle in `dist/` directory

The build is produced in the following formats depending on the options specified in `mirai.config.js`

-   `esm` - Built using rollup. (partial rollup config can be specified in `rollup.config.js` at project root)
-   `cjs` - Built using webpack. (partial webpack config can be specified in `webpack.config.js` at project root)
-   `cjsBundled` - [optional] Built using webpack. (partial webpack config can be specified in `webpack.config.js` at project root)
-   `umd` - Built using webpack. (partial webpack config can be specified in `webpack.config.js` at project root)

### mirai-scripts start

```
Usage: mirai-scripts start [options]
Use e.g. "mirai-scripts start" directly".
Options:
  -h --help              Print this help
  -n --name              Name of the project

```

`mirai-scripts start` command starts a dev server (based on rollup & webpack-dev-server)
that comes with HMR (Hot-Module-Replacement) working out of the box.

The dev server build is produced in the following formats depending on the options specified in `mirai.config.js`

-   `esm` - Built using rollup. (partial rollup config can be specified in `rollup.config.js` at project root)
-   `cjs` - Built using webpack. (partial webpack config can be specified in `webpack.config.js` at project root)
-   `cjsBundled` - [optional] Built using webpack. (partial webpack config can be specified in `webpack.config.js` at project root)
-   `umd` - Built using webpack. (partial webpack config can be specified in `webpack.config.js` at project root)

you can use npm folder links to install this to any other project and
watch it live updated as you change code in your mirai-scripts project

### mirai-scripts release

```
Usage: mirai-scripts release [options]
Use e.g. "mirai-scripts release" directly".

```

`mirai-scripts release` command internally uses [release-it](https://github.com/release-it/release-it) for release management
All options from `release-it` are supported by default

you're recommended to add `prepack` command to build before calling release

```json
{
	"scripts": {
		"build": "mirai-scripts build",
		"prepack": "npm run build",
		"release": "mirai-scripts release"
	}
}
```
