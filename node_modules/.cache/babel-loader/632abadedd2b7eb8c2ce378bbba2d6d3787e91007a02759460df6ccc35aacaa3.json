{"ast":null,"code":"import _defineProperty from \"@babel/runtime/helpers/defineProperty\";\nimport { MiraiConnection } from '../connection/mirai-connection';\nimport { Core } from './core';\nimport { ServiceQueryRequest } from '../../shared/utils/service-query-request';\nimport { MiraiIDAPI } from '../transports/http/http-miraiid';\nimport { NoAccessToken, SDKError } from '../errors';\nconst MIRAI_SIGN_PAGE = 'https://mirai-app-sdk-demo.vercel.app/sign';\nexport class MiraiCore extends Core {\n  constructor(opts) {\n    super(opts);\n    _defineProperty(this, \"chains\", void 0);\n    _defineProperty(this, \"namespace\", void 0);\n    _defineProperty(this, \"connections\", void 0);\n    _defineProperty(this, \"onOpenConnectionModal\", void 0);\n    _defineProperty(this, \"onCloseConnectionModal\", void 0);\n    this.chains = opts.chains;\n    this.namespace = opts.chainNameSpace;\n    this.onOpenConnectionModal = opts.onOpenConnectionModal;\n    this.onCloseConnectionModal = opts.onCloseConnectionModal;\n  }\n  static async init(opts) {\n    const core = new MiraiCore(opts);\n    await core.initialize();\n    return core;\n  }\n  async connect(_ref) {\n    let {\n      accessToken\n    } = _ref;\n    if (!accessToken) {\n      throw new NoAccessToken(SDKError.NoConnection, 'Not found access token. Pleases connect MiraiID first');\n    }\n    const newConnection = await MiraiConnection.init();\n    newConnection.emit('chains', this.chains);\n    newConnection.emit('namespace', this.namespace);\n    this.emit('connecting');\n    const isConnected = await newConnection.connect({\n      accessToken\n    });\n    if (isConnected) {\n      newConnection.on('disconnected', async () => {\n        typeof this.onCloseConnectionModal === 'function' && (await this.onCloseConnectionModal(newConnection));\n      });\n      this.connections[newConnection.topicId] = newConnection;\n      this.emit('new_connection', {\n        topicId: newConnection.topicId\n      });\n    } else {\n      throw new Error('Not connection');\n    }\n    return newConnection;\n  }\n  async getConnection(_ref2) {\n    let {\n      topicId\n    } = _ref2;\n    return this.connections[topicId];\n  }\n  async showConnectionModal(connection) {\n    return new Promise(async (resolve, reject) => {\n      const topicId = connection.topicId;\n      connection.on('display_uri', async uri => {\n        console.log('uri', uri);\n        if (!uri) {\n          reject(false);\n        }\n        // FIX BUG ADD_PARAM\n        const url = new URL(MIRAI_SIGN_PAGE);\n        const __serviceQuery = new ServiceQueryRequest(url.href, url.searchParams.toString());\n        __serviceQuery.addParam('topicId', topicId);\n        __serviceQuery.addParam('wc_uri', uri);\n        if (uri) {\n          console.log(__serviceQuery.toUri());\n          typeof this.onOpenConnectionModal === 'function' && (await this.onOpenConnectionModal(connection, __serviceQuery.toUri()));\n        }\n        resolve(true);\n      });\n      const {\n        namespace,\n        chains,\n        accessToken\n      } = connection;\n\n      // We're get pairing uri\n      await MiraiIDAPI.INSTANCE.getPairingUri(namespace, chains, accessToken);\n    });\n  }\n  async disconnect(connection) {\n    if (connection) {\n      await connection.disconnect();\n    }\n  }\n  disconnectAll() {\n    throw new Error('Method not implemented.');\n  }\n\n  // PRIVATE\n  async initialize() {\n    try {\n      // FOR INITIALIZE SOMETHING\n\n      this.connections = {};\n    } catch (e) {\n      console.error(e);\n    }\n  }\n}","map":{"version":3,"names":["MiraiConnection","Core","ServiceQueryRequest","MiraiIDAPI","NoAccessToken","SDKError","MIRAI_SIGN_PAGE","MiraiCore","constructor","opts","_defineProperty","chains","namespace","chainNameSpace","onOpenConnectionModal","onCloseConnectionModal","init","core","initialize","connect","_ref","accessToken","NoConnection","newConnection","emit","isConnected","on","connections","topicId","Error","getConnection","_ref2","showConnectionModal","connection","Promise","resolve","reject","uri","console","log","url","URL","__serviceQuery","href","searchParams","toString","addParam","toUri","INSTANCE","getPairingUri","disconnect","disconnectAll","e","error"],"sources":["/Users/phuocnd/phuocnd/works/mirai/miraiidjs/src/sign-provider/cores/mirai-core.ts"],"sourcesContent":["import { MiraiConnection } from '../connection/mirai-connection';\nimport { Core, ICore } from './core';\nimport { Connection } from '../connection/connection';\nimport { ServiceQueryRequest } from '../../shared/utils/service-query-request';\nimport { MiraiIDAPI } from '../transports/http/http-miraiid';\nimport { NoAccessToken, SDKError } from '../errors';\n\nconst MIRAI_SIGN_PAGE: string = 'https://mirai-app-sdk-demo.vercel.app/sign';\n\nexport class MiraiCore extends Core {\n\tchains: string[];\n\tnamespace: string;\n\tconnections: Record<string, MiraiConnection>;\n\n\tonOpenConnectionModal: (connnection: Connection, url: string) => Promise<void>;\n\tonCloseConnectionModal: (connnection: Connection) => Promise<void>;\n\n\tconstructor(opts?: ICore) {\n\t\tsuper(opts);\n\n\t\tthis.chains = opts.chains;\n\t\tthis.namespace = opts.chainNameSpace;\n\t\tthis.onOpenConnectionModal = opts.onOpenConnectionModal;\n\t\tthis.onCloseConnectionModal = opts.onCloseConnectionModal;\n\t}\n\n\tstatic async init(opts?: ICore) {\n\t\tconst core = new MiraiCore(opts);\n\t\tawait core.initialize();\n\n\t\treturn core;\n\t}\n\n\tpublic async connect({ accessToken }: { accessToken: string }) {\n\t\tif (!accessToken) {\n\t\t\tthrow new NoAccessToken(SDKError.NoConnection, 'Not found access token. Pleases connect MiraiID first');\n\t\t}\n\n\t\tconst newConnection = await MiraiConnection.init();\n\n\t\tnewConnection.emit('chains', this.chains);\n\t\tnewConnection.emit('namespace', this.namespace);\n\t\tthis.emit('connecting');\n\t\tconst isConnected = await newConnection.connect({ accessToken });\n\n\t\tif (isConnected) {\n\t\t\tnewConnection.on('disconnected', async () => {\n\t\t\t\ttypeof this.onCloseConnectionModal === 'function' && (await this.onCloseConnectionModal(newConnection));\n\t\t\t});\n\n\t\t\tthis.connections[newConnection.topicId] = newConnection;\n\t\t\tthis.emit('new_connection', { topicId: newConnection.topicId });\n\t\t} else {\n\t\t\tthrow new Error('Not connection');\n\t\t}\n\n\t\treturn newConnection;\n\t}\n\n\tpublic async getConnection({ topicId }: { topicId: string }): Promise<Connection> {\n\t\treturn this.connections[topicId];\n\t}\n\n\tpublic async showConnectionModal(connection: MiraiConnection) {\n\t\treturn new Promise(async (resolve, reject) => {\n\t\t\tconst topicId = connection.topicId;\n\n\t\t\tconnection.on('display_uri', async (uri: string) => {\n\t\t\t\tconsole.log('uri', uri);\n\t\t\t\tif (!uri) {\n\t\t\t\t\treject(false);\n\t\t\t\t}\n\t\t\t\t// FIX BUG ADD_PARAM\n\t\t\t\tconst url = new URL(MIRAI_SIGN_PAGE);\n\t\t\t\tconst __serviceQuery = new ServiceQueryRequest(url.href, url.searchParams.toString());\n\n\t\t\t\t__serviceQuery.addParam('topicId', topicId);\n\t\t\t\t__serviceQuery.addParam('wc_uri', uri);\n\n\t\t\t\tif (uri) {\n\t\t\t\t\tconsole.log(__serviceQuery.toUri());\n\t\t\t\t\ttypeof this.onOpenConnectionModal === 'function' &&\n\t\t\t\t\t\t(await this.onOpenConnectionModal(connection, __serviceQuery.toUri()));\n\t\t\t\t}\n\t\t\t\tresolve(true);\n\t\t\t});\n\n\t\t\tconst { namespace, chains, accessToken } = connection;\n\n\t\t\t// We're get pairing uri\n\t\t\tawait MiraiIDAPI.INSTANCE.getPairingUri(namespace, chains, accessToken);\n\t\t});\n\t}\n\n\tpublic async disconnect(connection: Connection): Promise<void> {\n\t\tif (connection) {\n\t\t\tawait connection.disconnect();\n\t\t}\n\t}\n\n\tpublic disconnectAll(): Promise<void> {\n\t\tthrow new Error('Method not implemented.');\n\t}\n\n\t// PRIVATE\n\tasync initialize() {\n\t\ttry {\n\t\t\t// FOR INITIALIZE SOMETHING\n\n\t\t\tthis.connections = {};\n\t\t} catch (e) {\n\t\t\tconsole.error(e);\n\t\t}\n\t}\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}