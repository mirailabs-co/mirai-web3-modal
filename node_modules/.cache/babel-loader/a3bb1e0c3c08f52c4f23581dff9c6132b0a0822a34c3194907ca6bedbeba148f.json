{"ast":null,"code":"import _defineProperty from \"@babel/runtime/helpers/defineProperty\";\nvar _class;\nimport { AUTH_TOKEN_KEY } from '../constants';\nimport { IAuthToken } from '../types/auth-token';\nimport { validateJwt } from '../utils';\nimport { LocalStorageBackend } from '../utils/storage';\nconst AUTH_EXPIRY_BUFFER = 1 * 60 * -1; // 1 mins in seconds\n\nclass AuthToken extends IAuthToken {\n  constructor(opts) {\n    super(opts);\n  }\n  static save(token) {\n    if (!this._storageBackend) {\n      this._storageBackend = new LocalStorageBackend();\n    }\n    Promise.all([this._storageBackend.setItem(AUTH_TOKEN_KEY, JSON.stringify(token))]).then(() => {\n      this.token = token;\n    });\n  }\n  static async get() {\n    let token = this.token;\n    if (!token) {\n      const tokenFromStorage = JSON.parse(await this._storageBackend.getItem(AUTH_TOKEN_KEY));\n      if (tokenFromStorage) {\n        token = tokenFromStorage;\n        this.token = token;\n      }\n    }\n    return token;\n  }\n  static async isValid() {\n    let buffer = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : AUTH_EXPIRY_BUFFER;\n    try {\n      return validateJwt(this.token.access_token, buffer);\n    } catch (e) {}\n    return false;\n  }\n  static async isValidRefreshToken() {\n    try {\n      return validateJwt(this.token.refresh_token);\n    } catch (e) {}\n    return false;\n  }\n}\n_class = AuthToken;\n_defineProperty(AuthToken, \"_storageBackend\", null);\n_defineProperty(AuthToken, \"token\", null);\n_defineProperty(AuthToken, \"initInstanceStorage\", () => {\n  _class._storageBackend = new LocalStorageBackend();\n});\nexport { AuthToken };","map":{"version":3,"names":["AUTH_TOKEN_KEY","IAuthToken","validateJwt","LocalStorageBackend","AUTH_EXPIRY_BUFFER","AuthToken","constructor","opts","save","token","_storageBackend","Promise","all","setItem","JSON","stringify","then","get","tokenFromStorage","parse","getItem","isValid","buffer","arguments","length","undefined","access_token","e","isValidRefreshToken","refresh_token","_class","_defineProperty"],"sources":["/Users/phuocnd/phuocnd/works/mirai/miraiidjs/src/auth-client/controllers/auth-token.ts"],"sourcesContent":["import { AUTH_TOKEN_KEY, auth } from '../constants';\nimport { AuthTokenTypes, IAuthToken } from '../types/auth-token';\nimport { validateJwt } from '../utils';\nimport { LocalStorageBackend, StorageBackend } from '../utils/storage';\n\nconst AUTH_EXPIRY_BUFFER = 1 * 60 * -1; // 1 mins in seconds\n\nclass AuthToken extends IAuthToken {\n\tstatic _storageBackend: StorageBackend = null;\n\tprivate static token: auth.TMiraiAccessToken | undefined = null;\n\n\tconstructor(opts: auth.TMiraiAccessToken) {\n\t\tsuper(opts);\n\t}\n\n\tstatic initInstanceStorage = () => {\n\t\tthis._storageBackend = new LocalStorageBackend();\n\t};\n\n\tstatic save(token: auth.TMiraiAccessToken) {\n\t\tif (!this._storageBackend) {\n\t\t\tthis._storageBackend = new LocalStorageBackend();\n\t\t}\n\t\tPromise.all([this._storageBackend.setItem(AUTH_TOKEN_KEY, JSON.stringify(token))]).then(() => {\n\t\t\tthis.token = token;\n\t\t});\n\t}\n\n\tstatic async get(): Promise<auth.TMiraiAccessToken> {\n\t\tlet token = this.token;\n\n\t\tif (!token) {\n\t\t\tconst tokenFromStorage = JSON.parse(\n\t\t\t\tawait this._storageBackend.getItem(AUTH_TOKEN_KEY),\n\t\t\t) as auth.TMiraiAccessToken;\n\n\t\t\tif (tokenFromStorage) {\n\t\t\t\ttoken = tokenFromStorage;\n\t\t\t\tthis.token = token;\n\t\t\t}\n\t\t}\n\n\t\treturn token;\n\t}\n\n\tstatic async isValid(buffer: number = AUTH_EXPIRY_BUFFER): Promise<boolean> {\n\t\ttry {\n\t\t\treturn validateJwt(this.token.access_token, buffer);\n\t\t} catch (e) {}\n\t\treturn false;\n\t}\n\n\tstatic async isValidRefreshToken(): Promise<boolean> {\n\t\ttry {\n\t\t\treturn validateJwt(this.token.refresh_token);\n\t\t} catch (e) {}\n\t\treturn false;\n\t}\n}\n\nexport { AuthToken };\n"],"mappings":";;AAAA,SAASA,cAAc,QAAc,cAAc;AACnD,SAAyBC,UAAU,QAAQ,qBAAqB;AAChE,SAASC,WAAW,QAAQ,UAAU;AACtC,SAASC,mBAAmB,QAAwB,kBAAkB;AAEtE,MAAMC,kBAAkB,GAAG,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC,CAAC,CAAC;;AAExC,MAAMC,SAAS,SAASJ,UAAU,CAAC;EAIlCK,WAAWA,CAACC,IAA4B,EAAE;IACzC,KAAK,CAACA,IAAI,CAAC;EACZ;EAMA,OAAOC,IAAIA,CAACC,KAA6B,EAAE;IAC1C,IAAI,CAAC,IAAI,CAACC,eAAe,EAAE;MAC1B,IAAI,CAACA,eAAe,GAAG,IAAIP,mBAAmB,CAAC,CAAC;IACjD;IACAQ,OAAO,CAACC,GAAG,CAAC,CAAC,IAAI,CAACF,eAAe,CAACG,OAAO,CAACb,cAAc,EAAEc,IAAI,CAACC,SAAS,CAACN,KAAK,CAAC,CAAC,CAAC,CAAC,CAACO,IAAI,CAAC,MAAM;MAC7F,IAAI,CAACP,KAAK,GAAGA,KAAK;IACnB,CAAC,CAAC;EACH;EAEA,aAAaQ,GAAGA,CAAA,EAAoC;IACnD,IAAIR,KAAK,GAAG,IAAI,CAACA,KAAK;IAEtB,IAAI,CAACA,KAAK,EAAE;MACX,MAAMS,gBAAgB,GAAGJ,IAAI,CAACK,KAAK,CAClC,MAAM,IAAI,CAACT,eAAe,CAACU,OAAO,CAACpB,cAAc,CAClD,CAA2B;MAE3B,IAAIkB,gBAAgB,EAAE;QACrBT,KAAK,GAAGS,gBAAgB;QACxB,IAAI,CAACT,KAAK,GAAGA,KAAK;MACnB;IACD;IAEA,OAAOA,KAAK;EACb;EAEA,aAAaY,OAAOA,CAAA,EAAwD;IAAA,IAAvDC,MAAc,GAAAC,SAAA,CAAAC,MAAA,QAAAD,SAAA,QAAAE,SAAA,GAAAF,SAAA,MAAGnB,kBAAkB;IACvD,IAAI;MACH,OAAOF,WAAW,CAAC,IAAI,CAACO,KAAK,CAACiB,YAAY,EAAEJ,MAAM,CAAC;IACpD,CAAC,CAAC,OAAOK,CAAC,EAAE,CAAC;IACb,OAAO,KAAK;EACb;EAEA,aAAaC,mBAAmBA,CAAA,EAAqB;IACpD,IAAI;MACH,OAAO1B,WAAW,CAAC,IAAI,CAACO,KAAK,CAACoB,aAAa,CAAC;IAC7C,CAAC,CAAC,OAAOF,CAAC,EAAE,CAAC;IACb,OAAO,KAAK;EACb;AACD;AAACG,MAAA,GAnDKzB,SAAS;AAAA0B,eAAA,CAAT1B,SAAS,qBAC2B,IAAI;AAAA0B,eAAA,CADxC1B,SAAS,WAE6C,IAAI;AAAA0B,eAAA,CAF1D1B,SAAS,yBAQe,MAAM;EAClCyB,MAAA,CAAKpB,eAAe,GAAG,IAAIP,mBAAmB,CAAC,CAAC;AACjD,CAAC;AA2CF,SAASE,SAAS"},"metadata":{},"sourceType":"module","externalDependencies":[]}