{"ast":null,"code":"import _defineProperty from \"@babel/runtime/helpers/defineProperty\";\nimport { SignerWebSocketService } from '../transports/websocket/ws-signer';\nimport { Connection } from './connection';\nimport { MiraiProvider } from '../providers/mirai-provider';\nimport { parseUserInfoFromAccessToken } from '../../utils/auth-util';\nimport { calculateRoomId } from '../../utils/socket-util';\n// export const MiraiRelayerUrl: string = 'wss://id-api-dev.mirailabs.co/mpc';\n\nclass MiraiConnection extends Connection {\n  constructor(opts) {\n    super(opts);\n    _defineProperty(this, \"topicId\", void 0);\n    _defineProperty(this, \"wcTopicId\", void 0);\n    // FOR PROVIDER\n    _defineProperty(this, \"chains\", void 0);\n    _defineProperty(this, \"namespace\", void 0);\n    _defineProperty(this, \"miraiRelayerUrl\", 'https://dev-sign-provider.miraiid.io');\n    _defineProperty(this, \"pending\", false);\n    _defineProperty(this, \"initializing\", false);\n    _defineProperty(this, \"initialized\", false);\n    _defineProperty(this, \"isApproved\", false);\n    // FOR WS CONNECTION\n    _defineProperty(this, \"accessToken\", void 0);\n    _defineProperty(this, \"ws\", void 0);\n    this.accessToken = opts.accessToken || null;\n  }\n  static async init() {\n    let {\n      accessToken\n    } = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n    const connection = new MiraiConnection({\n      accessToken\n    });\n    await connection.initialize();\n    return connection;\n  }\n  async getProvider() {\n    if (this.isApproved) {\n      return await MiraiProvider.init({\n        connection: this,\n        chainId: this.chains[0]\n      });\n    }\n    return null;\n  }\n  isConnected() {\n    return this.initialized;\n  }\n\n  // PRIVATE\n  async initialize() {\n    if (this.pending) {\n      return new Promise((resolve, reject) => {\n        this.once('open', () => {\n          this.once('open_error', error => {\n            reject(error);\n          });\n          if (typeof this.ws === 'undefined') {\n            return reject(new Error('WS not initialized'));\n          }\n          resolve();\n        });\n      });\n    }\n    try {\n      this.pending = true;\n      await this._registerListener();\n      if (this.accessToken) {\n        await this.register(this.accessToken);\n      }\n      this.emit('open');\n    } catch (e) {\n      this.emit('open_error', e);\n      throw e;\n    }\n  }\n  async register(accessToken) {\n    if (typeof this.ws !== 'undefined') {\n      return this.ws;\n    }\n    if (this.initializing) {\n      return new Promise((resolve, reject) => {\n        this.once('register_error', error => {\n          reject(error);\n        });\n        this.once('init', () => {\n          if (typeof this.ws === 'undefined') {\n            return reject(new Error('WS not initialized'));\n          }\n          resolve(this.ws);\n        });\n      });\n    }\n    try {\n      this.initializing = true;\n      this.ws = new SignerWebSocketService({\n        url: this.miraiRelayerUrl,\n        accessToken\n      });\n      this.initializing = false;\n      this.emit('init');\n      return this.ws;\n    } catch (e) {\n      this.emit('register_error', e);\n      throw e;\n    }\n  }\n  async connect(_ref) {\n    let {\n      accessToken\n    } = _ref;\n    return new Promise(async (resolve, reject) => {\n      try {\n        if (!this.ws || this.ws === undefined) {\n          await this.register(accessToken);\n        }\n        const socket = await this.ws.establish(true);\n        socket.on('disconnect', async reason => {\n          console.log('disconnect', reason);\n          this.emit('disconnected', reason);\n          await this.resetAll();\n        });\n        socket.on('connect', async () => {\n          const miraiInfo = await parseUserInfoFromAccessToken(accessToken);\n          if (!miraiInfo) {\n            socket.disconnect();\n          }\n          const {\n            sub,\n            aud\n          } = miraiInfo;\n          const internalTopicId = calculateRoomId(sub, aud);\n          this.emit('connected', internalTopicId);\n          this.accessToken = accessToken;\n          this.initialized = true;\n          socket.getSocket().on(internalTopicId, received => {\n            console.log('received', received);\n            const {\n              type,\n              payload\n            } = received;\n            if (type === 'uri') {\n              this.emit('display_uri', payload);\n            }\n            if (type === 'topic') {\n              this.wcTopicId = payload;\n              this.isApproved = true;\n              this.emit('approved', {\n                topicId: this.topicId\n              });\n              if (typeof window !== 'undefined' && window !== undefined) {\n                window.postMessage({\n                  topicId: this.topicId,\n                  message: 'user_approved'\n                }, '*');\n              }\n            }\n            if (type === 'error-topic') {\n              this.emit('error', payload);\n              // reject(false);\n            }\n\n            if (type === 'error') {\n              this.emit('error', payload);\n              // reject(false);\n            }\n\n            resolve(true);\n          });\n          resolve(true);\n        });\n        socket.on('connect_error', reason => {\n          this.emit('error', reason);\n          reject(false);\n        });\n        socket.connect();\n      } catch (error) {\n        console.error(error);\n        throw error;\n      } finally {}\n    });\n  }\n  async disconnect() {\n    return new Promise((resolve, reject) => {\n      if (this.ws.socket.getSocket().connected) {\n        if (this.ws.socket.disconnect()) {\n          this.emit('disconnected');\n          resolve(true);\n        }\n      } else {\n        this.emit('disconnected');\n        resolve(true);\n      }\n      resolve(false);\n    });\n  }\n  async resetAll() {\n    await this.disconnect();\n    this.removeAllListeners();\n    this.accessToken = null;\n    this.chains = [];\n    this.initialized = false;\n    this.namespace = null;\n  }\n  async _registerListener() {\n    this.once('connected', async topic => {\n      this.topicId = topic;\n      if (typeof window !== 'undefined' && window !== undefined) {\n        window.addEventListener('message', async event => {\n          const {\n            data\n          } = event;\n          const {\n            topic,\n            message\n          } = data;\n\n          // if (topic === this.topicId && 'window_closed' === message) {\n          // \tawait this.resetAll();\n          // }\n        });\n      }\n    });\n\n    this.once('namespace', namespace => {\n      this.namespace = namespace;\n    });\n    this.once('chains', chains => {\n      this.chains = chains;\n    });\n  }\n}\nexport { MiraiConnection };","map":{"version":3,"names":["SignerWebSocketService","Connection","MiraiProvider","parseUserInfoFromAccessToken","calculateRoomId","MiraiConnection","constructor","opts","_defineProperty","accessToken","init","arguments","length","undefined","connection","initialize","getProvider","isApproved","chainId","chains","isConnected","initialized","pending","Promise","resolve","reject","once","error","ws","Error","_registerListener","register","emit","e","initializing","url","miraiRelayerUrl","connect","_ref","socket","establish","on","reason","console","log","resetAll","miraiInfo","disconnect","sub","aud","internalTopicId","getSocket","received","type","payload","wcTopicId","topicId","window","postMessage","message","connected","removeAllListeners","namespace","topic","addEventListener","event","data"],"sources":["/Users/phuocnd/phuocnd/works/mirai/miraiidjs/src/sign-provider/connection/mirai-connection.ts"],"sourcesContent":["import { SignerWebSocketService } from '../transports/websocket/ws-signer';\nimport { Connection, ConnectionOpts } from './connection';\nimport { MiraiProvider } from '../providers/mirai-provider';\nimport { parseUserInfoFromAccessToken } from '../../utils/auth-util';\nimport { calculateRoomId } from '../../utils/socket-util';\nimport { InternalSocketEvent } from './types';\n\n// export const MiraiRelayerUrl: string = 'wss://id-api-dev.mirailabs.co/mpc';\n\nclass MiraiConnection extends Connection {\n\tpublic topicId: string;\n\tpublic wcTopicId: string;\n\n\t// FOR PROVIDER\n\tpublic chains: string[];\n\tpublic namespace: string;\n\n\tprivate readonly miraiRelayerUrl: string = 'https://dev-sign-provider.miraiid.io';\n\n\tprivate pending = false;\n\tprivate initializing = false;\n\tprivate initialized = false;\n\tprivate isApproved: boolean = false;\n\n\t// FOR WS CONNECTION\n\tpublic accessToken: string;\n\tpublic ws: InstanceType<typeof SignerWebSocketService>;\n\n\tconstructor(opts: ConnectionOpts) {\n\t\tsuper(opts);\n\n\t\tthis.accessToken = opts.accessToken || null;\n\t}\n\n\tpublic static async init({ accessToken }: { accessToken?: string } = {}) {\n\t\tconst connection = new MiraiConnection({ accessToken });\n\n\t\tawait connection.initialize();\n\n\t\treturn connection;\n\t}\n\n\tpublic async getProvider(): Promise<MiraiProvider> {\n\t\tif (this.isApproved) {\n\t\t\treturn await MiraiProvider.init({\n\t\t\t\tconnection: this,\n\t\t\t\tchainId: this.chains[0],\n\t\t\t});\n\t\t}\n\t\treturn null;\n\t}\n\n\tpublic isConnected(): boolean {\n\t\treturn this.initialized;\n\t}\n\n\t// PRIVATE\n\tprivate async initialize(): Promise<void> {\n\t\tif (this.pending) {\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tthis.once('open', () => {\n\t\t\t\t\tthis.once('open_error', (error: any) => {\n\t\t\t\t\t\treject(error);\n\t\t\t\t\t});\n\t\t\t\t\tif (typeof this.ws === 'undefined') {\n\t\t\t\t\t\treturn reject(new Error('WS not initialized'));\n\t\t\t\t\t}\n\t\t\t\t\tresolve();\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\ttry {\n\t\t\tthis.pending = true;\n\t\t\tawait this._registerListener();\n\n\t\t\tif (this.accessToken) {\n\t\t\t\tawait this.register(this.accessToken);\n\t\t\t}\n\n\t\t\tthis.emit('open');\n\t\t} catch (e) {\n\t\t\tthis.emit('open_error', e);\n\t\t\tthrow e;\n\t\t}\n\t}\n\n\tprivate async register(accessToken: string): Promise<SignerWebSocketService> {\n\t\tif (typeof this.ws !== 'undefined') {\n\t\t\treturn this.ws;\n\t\t}\n\n\t\tif (this.initializing) {\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tthis.once('register_error', (error: any) => {\n\t\t\t\t\treject(error);\n\t\t\t\t});\n\t\t\t\tthis.once('init', () => {\n\t\t\t\t\tif (typeof this.ws === 'undefined') {\n\t\t\t\t\t\treturn reject(new Error('WS not initialized'));\n\t\t\t\t\t}\n\t\t\t\t\tresolve(this.ws);\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t\ttry {\n\t\t\tthis.initializing = true;\n\n\t\t\tthis.ws = new SignerWebSocketService({\n\t\t\t\turl: this.miraiRelayerUrl,\n\t\t\t\taccessToken,\n\t\t\t});\n\n\t\t\tthis.initializing = false;\n\t\t\tthis.emit('init');\n\t\t\treturn this.ws;\n\t\t} catch (e) {\n\t\t\tthis.emit('register_error', e);\n\t\t\tthrow e;\n\t\t}\n\t}\n\n\tpublic async connect({ accessToken }: { accessToken: string }): Promise<boolean> {\n\t\treturn new Promise(async (resolve, reject) => {\n\t\t\ttry {\n\t\t\t\tif (!this.ws || this.ws === undefined) {\n\t\t\t\t\tawait this.register(accessToken);\n\t\t\t\t}\n\t\t\t\tconst socket = await this.ws.establish(true);\n\n\t\t\t\tsocket.on('disconnect', async (reason: string) => {\n\t\t\t\t\tconsole.log('disconnect', reason);\n\t\t\t\t\tthis.emit('disconnected', reason);\n\t\t\t\t\tawait this.resetAll();\n\t\t\t\t});\n\n\t\t\t\tsocket.on('connect', async () => {\n\t\t\t\t\tconst miraiInfo = await parseUserInfoFromAccessToken(accessToken);\n\t\t\t\t\tif (!miraiInfo) {\n\t\t\t\t\t\tsocket.disconnect();\n\t\t\t\t\t}\n\t\t\t\t\tconst { sub, aud } = miraiInfo;\n\t\t\t\t\tconst internalTopicId = calculateRoomId(sub, aud);\n\n\t\t\t\t\tthis.emit('connected', internalTopicId);\n\t\t\t\t\tthis.accessToken = accessToken;\n\n\t\t\t\t\tthis.initialized = true;\n\n\t\t\t\t\tsocket.getSocket().on(internalTopicId, (received: any) => {\n\t\t\t\t\t\tconsole.log('received', received);\n\t\t\t\t\t\tconst { type, payload } = received;\n\n\t\t\t\t\t\tif (type === 'uri') {\n\t\t\t\t\t\t\tthis.emit('display_uri', payload);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (type === 'topic') {\n\t\t\t\t\t\t\tthis.wcTopicId = payload as string;\n\n\t\t\t\t\t\t\tthis.isApproved = true;\n\n\t\t\t\t\t\t\tthis.emit('approved', {\n\t\t\t\t\t\t\t\ttopicId: this.topicId,\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\tif (typeof window !== 'undefined' && window !== undefined) {\n\t\t\t\t\t\t\t\twindow.postMessage({ topicId: this.topicId, message: 'user_approved' }, '*');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (type === 'error-topic') {\n\t\t\t\t\t\t\tthis.emit('error', payload);\n\t\t\t\t\t\t\t// reject(false);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (type === 'error') {\n\t\t\t\t\t\t\tthis.emit('error', payload);\n\t\t\t\t\t\t\t// reject(false);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tresolve(true);\n\t\t\t\t\t});\n\n\t\t\t\t\tresolve(true);\n\t\t\t\t});\n\n\t\t\t\tsocket.on('connect_error', (reason: string) => {\n\t\t\t\t\tthis.emit('error', reason);\n\t\t\t\t\treject(false);\n\t\t\t\t});\n\n\t\t\t\tsocket.connect();\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error(error);\n\t\t\t\tthrow error;\n\t\t\t} finally {\n\t\t\t}\n\t\t});\n\t}\n\n\tpublic async disconnect(): Promise<boolean> {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tif (this.ws.socket.getSocket().connected) {\n\t\t\t\tif (this.ws.socket.disconnect()) {\n\t\t\t\t\tthis.emit('disconnected');\n\t\t\t\t\tresolve(true);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthis.emit('disconnected');\n\t\t\t\tresolve(true);\n\t\t\t}\n\n\t\t\tresolve(false);\n\t\t});\n\t}\n\n\tprivate async resetAll(): Promise<void> {\n\t\tawait this.disconnect();\n\n\t\tthis.removeAllListeners();\n\n\t\tthis.accessToken = null;\n\t\tthis.chains = [];\n\t\tthis.initialized = false;\n\t\tthis.namespace = null;\n\t}\n\n\tprivate async _registerListener() {\n\t\tthis.once('connected', async (topic: string) => {\n\t\t\tthis.topicId = topic;\n\n\t\t\tif (typeof window !== 'undefined' && window !== undefined) {\n\t\t\t\twindow.addEventListener('message', async (event) => {\n\t\t\t\t\tconst { data } = event;\n\n\t\t\t\t\tconst { topic, message } = data;\n\n\t\t\t\t\t// if (topic === this.topicId && 'window_closed' === message) {\n\t\t\t\t\t// \tawait this.resetAll();\n\t\t\t\t\t// }\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\n\t\tthis.once('namespace', (namespace: string) => {\n\t\t\tthis.namespace = namespace;\n\t\t});\n\n\t\tthis.once('chains', (chains: string[]) => {\n\t\t\tthis.chains = chains;\n\t\t});\n\t}\n}\n\nexport { MiraiConnection };\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}